<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【Vue3】API | Big Rice 🍚</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="根据官网整理了 Vue3 中的 API">
    
    <link rel="preload" href="/bigRiceRice.io/dist/assets/css/0.styles.07d2ad69.css" as="style"><link rel="preload" href="/bigRiceRice.io/dist/assets/js/app.e40e56d4.js" as="script"><link rel="preload" href="/bigRiceRice.io/dist/assets/js/6.4adeed80.js" as="script"><link rel="preload" href="/bigRiceRice.io/dist/assets/js/3.2a259be5.js" as="script"><link rel="preload" href="/bigRiceRice.io/dist/assets/js/61.10bdb60c.js" as="script"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/10.5590a827.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/11.168de83c.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/12.568a4166.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/13.e940090d.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/14.dc0bcdc3.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/15.d1d3e4db.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/16.ebeb32bf.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/17.c3dd4d0c.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/18.f866ec42.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/19.b1cb79cd.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/20.5be10f1b.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/21.9d4d5a4c.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/22.c3add0f7.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/23.4de16fde.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/24.471429ef.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/25.3a1e5f8f.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/26.f7beff95.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/27.0853cfce.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/28.ee76b4d9.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/29.cbfc2db4.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/30.07a7e574.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/31.bbd098e3.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/32.ead5b9a7.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/33.37495d61.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/34.be3ea514.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/35.e69c119d.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/36.567f1f05.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/37.31e20c86.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/38.b0925063.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/39.f588d93f.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/4.cb5dc486.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/40.9348ddae.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/41.3f59a68b.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/42.437e7888.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/43.65f0a71a.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/44.b69b697f.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/45.6368e269.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/46.2c134927.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/47.aa7eacac.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/48.2cf1db2b.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/49.4d7bf943.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/5.44ec780a.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/50.ad5e5ae9.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/51.5808d818.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/52.9cf1cb74.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/53.506fdaeb.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/54.2b22996a.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/55.5231db92.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/56.fb63a532.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/57.b1ab4ac7.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/58.1f35c496.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/59.4c13ca5c.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/60.dd86caec.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/62.79bd5628.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/63.c1e64965.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/64.0844e861.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/65.d83ee281.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/66.912efc81.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/67.264e33aa.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/68.471581d3.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/69.d2cc646e.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/7.a918f9c2.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/70.39b927a0.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/71.35eabcc2.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/72.f98b9f33.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/73.d5ba8d76.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/74.1eb2ee3c.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/75.9b097318.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/76.96abd87e.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/77.a79060a6.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/78.0d34317d.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/79.bc097473.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/8.45199285.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/80.69352813.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/81.81cb0786.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/82.f9e415e6.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/83.c47b3520.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/84.26b7d911.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/85.7204efd5.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/86.10900b48.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/87.101df704.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/88.f98c1d02.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/89.488a74f0.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/9.2eadd3a5.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/90.cbae52bc.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/91.39790983.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/92.215a930e.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/93.40a27a87.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/94.28fd71ca.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/95.7545f6b2.js"><link rel="prefetch" href="/bigRiceRice.io/dist/assets/js/vuejs-paginate.bd98283b.js">
    <link rel="stylesheet" href="/bigRiceRice.io/dist/assets/css/0.styles.07d2ad69.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/bigRiceRice.io/dist/" class="nav-link home-link">Big Rice 🍚 </a> <button class="back" style="display:;">↩</button></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/bigRiceRice.io/dist/FrameWork/" class="nav-link">框架</a></li><li class="nav-item"><a href="/bigRiceRice.io/dist/Css/" class="nav-link">Css</a></li><li class="nav-item"><a href="/bigRiceRice.io/dist/API/" class="nav-link">API</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/bigRiceRice.io/dist/" class="nav-link mobile-home-link">Big Rice 🍚 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/bigRiceRice.io/dist/FrameWork/" class="nav-link">框架</a></li><li class="mobile-nav-item"><a href="/bigRiceRice.io/dist/Css/" class="nav-link">Css</a></li><li class="mobile-nav-item"><a href="/bigRiceRice.io/dist/API/" class="nav-link">API</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        【Vue3】API
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">BigRice</span> <span itemprop="address">   in 云梦泽</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-12-20T00:00:00.000Z">
      2021-12-20
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/bigRiceRice.io/dist/tag/Vue3" data-v-42ccfcd5><span data-v-42ccfcd5>Vue3</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/bigRiceRice.io/dist/tag/API Vue3" data-v-42ccfcd5><span data-v-42ccfcd5>API Vue3</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="响应式核心-api"><a href="#响应式核心-api" class="header-anchor">#</a> 响应式核心 API</h2> <h3 id="ref"><a href="#ref" class="header-anchor">#</a> Ref</h3> <p>接收一个参数，返回一个响应式的、可更改的 <em>Ref</em> 对象，此对象只有一个指向其内部值的属性 <code>.value</code></p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> Ref<span class="token operator">&lt;</span>UnwrapRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>详细信息</p> <p><code>Ref</code> 对象是可更改的，但不能直接覆盖这个值，需要访问 <code>.value</code> 赋予值。它也是响应式的，即所有对 <code>.value</code> 的操作都将被追踪，并且会触发与之相关的副作用。</p> <p><code>Ref()</code> 本意是解决 <code>reactive</code> 的短板，假如将一个普通对象| Map | Set 集合类型的值使用 <code>Ref</code> 包装，那么内部其实会调用 <code>Reactive</code> 来包装。</p> <ul><li><p>如果这个对象中某个属性值是 <code>Ref</code> 对象，那么会将其解包作为属性值，这被称为<strong>深层解包</strong>。</p></li> <li><p><strong>重点来了</strong>，这个时候修改源对象中某个值为 <code>Ref</code> 对象的 <code>.value</code> 值的话，那么由 <code>Ref</code> 包装过的对象中的值也会跟着改变！</p> <img src="https://sbr-1314368469.cos.ap-guangzhou.myqcloud.com/Images/202301121339503.png" alt="image-20221215162713355" style="zoom:80%;"></li></ul> <p>若要避免这种深层次的转换，请使用 <a href="https://cn.vuejs.org/api/reactivity-advanced.html#shallowref" target="_blank" rel="noopener noreferrer"><code>shallowRef()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来替代。</p></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>

count<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div></li></ul> <h3 id="computed"><a href="#computed" class="header-anchor">#</a> Computed</h3> <p>接受一个 Getter 函数，返回一个只读的响应式 <a href="https://cn.vuejs.org/api/reactivity-core.html#ref" target="_blank" rel="noopener noreferrer">ref<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 对象。该 ref 通过 <code>.value</code> 暴露 getter 函数的返回值。它也可以接受一个带有 <code>get</code> 和 <code>set</code> 函数的对象来创建一个可写的 ref 对象。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 只读</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token function-variable function">getter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    <span class="token comment">// 用于 Debug</span>
    debuggerOptions<span class="token operator">?</span><span class="token operator">:</span> DebuggerOptions
<span class="token punctuation">)</span><span class="token operator">:</span> Readonly<span class="token operator">&lt;</span>Ref<span class="token operator">&lt;</span>Readonly<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 可写的</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">;</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    debuggerOptions<span class="token operator">?</span><span class="token operator">:</span> DebuggerOptions
<span class="token punctuation">)</span><span class="token operator">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p>若只传入一个 <code>Getter</code>（有返回值的）函数，那么会返回一个<strong>只读</strong>的 <em>Ref</em> 对象，<em>Ref</em> 对象的值就是 <code>Getter</code> 函数的返回值。</p> <p>若传入一个对象，那么返回值就是可读可写的 <em>Ref</em> 对象，参数对象必须是两个指定名称的函数：</p> <ol><li><code>Get()</code>：同 <code>Getter</code> ；</li> <li><code>Set(value)</code>：同 <code>Setter</code> ；</li></ol></li> <li><p><strong>注意</strong>：关于修改</p> <p>Computed 意为计算，那么若想修改它的返回值只能去<strong>修改它的依赖项</strong>进而重新触发 Getter 来达到修改返回值的目的！</p></li> <li><p>示例</p> <p>创建一个只读的计算属性 <em>Ref</em> ：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

plusOne<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 报错</span>
</code></pre></div><p>创建一个可写的计算属性 ref：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> val <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 修改 Get 计算的依赖性，再根据 Get 中的逻辑 -1</span>
        count<span class="token punctuation">.</span>value <span class="token operator">=</span> val <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

plusOne<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
</code></pre></div></li></ul> <h3 id="reactive"><a href="#reactive" class="header-anchor">#</a> Reactive</h3> <p>接收一个参数，若这个参数为 Object | Map | Set 等集合类型，那么返回一个 <code>Reactive</code> 对象的响应式代理。</p> <p>若这个参数为 String | Number 等基本类型，那么其实会使用 <code>ref()</code> 来包装，并返回一个 <code>Ref</code> 对象的响应式代理。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">reactive</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p><code>Reactive</code> 默认的响应式转换是“深层”的，它会影响到所有嵌套的属性。即<strong>深层解包</strong>，同时保持响应性。</p> <p>值得注意的是，当 <code>Reactve</code> 中的某个属性值为响应式数组或 Map 这样的集合类型，并且这个 Map 中的值是 <code>Ref</code> 对象时，将不会执行 <strong>Ref</strong> 的解包。</p> <p>若要避免深层响应式转换，只想保留对这个对象顶层次访问的响应性，请使用 <a href="https://cn.vuejs.org/api/reactivity-advanced.html#shallowreactive" target="_blank" rel="noopener noreferrer">shallowReactive()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 作替代。</p> <p>返回的对象以及其中嵌套的对象都会通过 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="noopener noreferrer">ES Proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包裹，因此<strong>不等于</strong>源对象，建议只使用响应式代理，<strong>避免使用原始对象</strong>。</p></li> <li><p><strong>注意</strong>：关于结构赋值</p> <p>当我们结构赋值 Reactive 中属性值为基本数据类型的值的话，那么将会丢失响应式，这是由于 <code>Proxy</code> 代理的局限性导致的。</p> <p>若结构赋值为 Object | Map | Set 这些引用了类型的话，响应式还会存在。</p> <ul><li><p>我们可以使用 <code>toRefs()</code> 来创建一组 Ref 对象来解决这个结构赋值问题。</p></li> <li><p>参见：<a href="https://juejin.cn/post/7080127118486552584" target="_blank" rel="noopener noreferrer">Vue3 Reactive 值为什么不推荐解构 &amp;&amp; 分析响应式结构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></li> <li><p>示例</p> <p>创建一个响应式对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// obj {count : 1}</span>
</code></pre></div><p>Ref 的解包：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ref 会被解包</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count <span class="token operator">===</span> count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// 会更新 `obj.count`</span>
count<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

<span class="token comment">// 也会更新 `count` ref</span>
obj<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><p>注意当访问到某个响应式数组或 <code>Map</code> 这样的原生集合类型中的 ref 元素时，<strong>不会</strong>执行 ref 的解包：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> books <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">&quot;Vue 3 Guide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这里需要 .value</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>books<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这里需要 .value</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将一个 <a href="https://cn.vuejs.org/api/reactivity-core.html#ref" target="_blank" rel="noopener noreferrer">ref<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 赋值给为一个 <code>reactive</code> 属性时，该 ref 会被自动解包</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>count <span class="token operator">===</span> count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div></li></ul> <h3 id="readonly"><a href="#readonly" class="header-anchor">#</a> Readonly</h3> <p>接受一个对象参数 (不论是响应式还是普通的) 或是一个 <a href="https://cn.vuejs.org/api/reactivity-core.html#ref" target="_blank" rel="noopener noreferrer">Ref<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 参数，并返回一个原值的<strong>只读</strong>代理</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token keyword">readonly</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> DeepReadonly<span class="token operator">&lt;</span>UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p>只读代理是深层的：对任何嵌套属性的访问都将是只读的。它的 ref 解包行为与 <code>reactive()</code> 相同，但解包得到的值是只读的。</p> <p>要避免深层级的转换行为，请使用 <a href="https://cn.vuejs.org/api/reactivity-advanced.html#shallowreadonly" target="_blank" rel="noopener noreferrer">shallowReadonly()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 作替代。</p></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> copy <span class="token operator">=</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用来做响应性追踪</span>
    <span class="token comment">// 因为 copy 的依赖是 original，所以 original 被修改那么就会触发代码块</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>copy<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更改源属性会触发其依赖的侦听器</span>
original<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>

<span class="token comment">// 更改该只读副本将会失败，并会得到一个警告</span>
copy<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// warning!</span>
</code></pre></div></li></ul> <h3 id="watcheffect"><a href="#watcheffect" class="header-anchor">#</a> WatchEffect</h3> <p>立即运行一个函数，同时响应式地追踪其依赖，并在依赖更改时重新执行。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span>
    <span class="token function-variable function">effect</span><span class="token operator">:</span> <span class="token punctuation">(</span>onCleanup<span class="token operator">:</span> OnCleanup<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> WatchEffectOptions
<span class="token punctuation">)</span><span class="token operator">:</span> StopHandle<span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">OnCleanup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">cleanupFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">WatchEffectOptions</span> <span class="token punctuation">{</span>
    flush<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&quot;pre&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;post&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 默认：'pre'</span>
    onTrack<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    onTrigger<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">StopHandle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p>第一个参数是一个函数要运行的侦听器函数，并且初始化<strong>自动调用一次</strong>这个侦听器函数。</p> <ul><li><p>侦听器函数的参数也是一个函数，这个函数中可以传入一个回调函数。</p></li> <li><p>❕❕ 并同时响应式追踪其所有依赖，并在依赖变更时重新运行该回调函数。❕❕</p> <ul><li><code>watchEffect</code> 根据依赖修改而自动触发。</li></ul></li> <li><p>回调函数会在<strong>除第一次</strong>初始化自动运行后的<strong>每一次侦听函数调用前</strong>执行。这个回调函数可以用来清理无效的副作用，例如：正在请求还未响应但又发起了一次请求时取消掉尚未响应的请求。</p></li></ul> <p>第二个参数是一个可选的选项，可以用来调整副作用的刷新时机或调试副作用的依赖。</p> <p>默认情况下，侦听器将在组件渲染之前执行。</p> <ul><li>设置 <code>flush: 'post'</code> 将会使侦听器延迟到组件渲染之后再执行。详见<a href="https://cn.vuejs.org/guide/essentials/watchers.html#callback-flush-timing" target="_blank" rel="noopener noreferrer">回调的触发时机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>在某些特殊情况下 (例如要使缓存失效)，可能有必要在响应式依赖发生改变时立即触发侦听器。这可以通过设置 <code>flush: 'sync'</code> 来实现。然而，该设置应谨慎使用，因为如果有多个属性同时更新，这将导致一些性能和数据一致性的问题。</li></ul> <p>返回值是一个用来删除此侦听器的函数。</p></li> <li><p><strong>注意</strong></p> <p>如果依赖是 Ref 和 Computed 对象，必须要加 <code>.value</code>，否则并不会视为依赖，Reactive 数据也只会侦听触发了属性</p></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// -&gt; 输出 0</span>

count<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token comment">// -&gt; 输出 1</span>
</code></pre></div><p>删除侦听器：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> stop <span class="token operator">=</span> <span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 当不再需要此侦听器时:</span>
<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>选项：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    flush<span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
    <span class="token function">onTrack</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onTrigger</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">debugger</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>清除副作用示例：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> watchEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getPath <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">&quot;home/getEcharsData&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://www.fastmock.site/mock/c177d4fd16e7300687fced45a9ca4a16/api/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>getPath<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> ref<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">&quot;请稍等...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 函数返回一个发起请求的方法与一个终止请求的方法</span>
<span class="token keyword">function</span> <span class="token function">abortableFetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">request</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span> <span class="token operator">=</span> controller<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">abort</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">send</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发起请求，这个请求会延一秒响应</span>
            <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token keyword">await</span> v<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    data<span class="token punctuation">.</span>value <span class="token operator">=</span> d<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求错误错误：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">switchUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getPath<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">&quot;home/getEcharsData&quot;</span>
        <span class="token operator">?</span> <span class="token punctuation">(</span>getPath<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;home/getCountData&quot;</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span>getPath<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;home/getEcharsData&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">onInvalidate</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> abort<span class="token punctuation">,</span> send <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">abortableFetch</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 副作用函数</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在除了初次自动调用以后每次调用前都会触发这个函数</span>
    <span class="token comment">// 在函数中清除了副作用函数效果（ 即取消正在请求中的 Http 请求 ）</span>
    <span class="token function">onInvalidate</span><span class="token punctuation">(</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ data }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>switchUrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>再次发起请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div> <img src="https://sbr-1314368469.cos.ap-guangzhou.myqcloud.com/Images/202301121339572.gif" alt="demo" style="zoom:80%;"></li></ul> <h3 id="watchposteffect"><a href="#watchposteffect" class="header-anchor">#</a> WatchPostEffect</h3> <p><code>watchEffect</code> 使用 <code>flush: 'post'</code> 选项时的别名。</p> <h3 id="watchsynceffect"><a href="#watchsynceffect" class="header-anchor">#</a> WatchSyncEffect</h3> <p><code>watchEffect</code> 使用 <code>flush: 'sync'</code> 选项时的别名。</p> <h3 id="watch"><a href="#watch" class="header-anchor">#</a> Watch</h3> <p>侦听一个或多个响应式数据源，并在数据源变化时调用所给的回调函数。</p> <ul><li><h5 id="ts-类型"><a href="#ts-类型" class="header-anchor">#</a> TS 类型</h5> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 侦听单个来源</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">watch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    source<span class="token operator">:</span> WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    callback<span class="token operator">:</span> WatchCallback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> WatchOptions
<span class="token punctuation">)</span><span class="token operator">:</span> StopHandle<span class="token punctuation">;</span>

<span class="token comment">// 侦听多个来源</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">watch</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    sources<span class="token operator">:</span> WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    callback<span class="token operator">:</span> WatchCallback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> WatchOptions
<span class="token punctuation">)</span><span class="token operator">:</span> StopHandle<span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">WatchCallback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    oldValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onCleanup</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function-variable function">cleanupFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span>
    <span class="token operator">|</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token comment">// ref</span>
    <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token comment">// getter</span>
    <span class="token operator">|</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span>
    <span class="token operator">?</span> <span class="token constant">T</span>
    <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span> <span class="token comment">// 响应式对象</span>

<span class="token keyword">interface</span> <span class="token class-name">WatchOptions</span> <span class="token keyword">extends</span> <span class="token class-name">WatchEffectOptions</span> <span class="token punctuation">{</span>
    immediate<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> <span class="token comment">// 默认：false</span>
    deep<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span> <span class="token comment">// 默认：false</span>
    flush<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">&quot;pre&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;post&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 默认：'pre'</span>
    onTrack<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    onTrigger<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> DebuggerEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>为了便于阅读，对类型进行了简化。</p></blockquote></li> <li><p>详细信息</p> <p><code>watch()</code> 默认是懒侦听的，即仅在侦听源发生变化时才执行回调函数。</p> <p>第一个参数是侦听器的<strong>来源 | 根据</strong>。这个来源可以是以下几种：</p> <ul><li>一个 <code>Getter</code> 函数，返回一个值</li> <li>一个 Ref 对象</li> <li>一个响应式对象</li> <li>或是由以上类型的值组成的数组</li></ul> <p>第二个参数是在发生变化时要调用的回调函数。这个回调函数接受三个参数：</p> <ul><li><p>新值、旧值，以及一个用于注册副作用清理的回调函数。该回调函数会在副作用下一次重新执行前调用，可以用来清除无效的副作用，例如等待中的异步请求。</p></li> <li><p>当侦听多个来源时，回调函数接受两个数组，分别对应来源数组中的新值和旧值。</p></li></ul> <p>第三个可选的参数是一个对象，支持以下这些选项：</p> <ul><li><code>immediate</code>：在侦听器创建时立即触发回调。第一次调用时旧值是 <code>undefined</code>。</li> <li><code>deep</code>：如果源是对象，强制深度遍历，以便在深层级变更时触发回调。参考<a href="https://cn.vuejs.org/guide/essentials/watchers.html#deep-watchers" target="_blank" rel="noopener noreferrer">深层侦听器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li><code>flush</code>：调整回调函数的刷新时机。参考<a href="https://cn.vuejs.org/guide/essentials/watchers.html#callback-flush-timing" target="_blank" rel="noopener noreferrer">回调的刷新时机<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>及 <code>watchEffect()</code></li> <li><code>onTrack / onTrigger</code>：调试侦听器的依赖。参考<a href="https://cn.vuejs.org/guide/extras/reactivity-in-depth.html#watcher-debugging" target="_blank" rel="noopener noreferrer">调试侦听器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <p>与 <code>watchEffect()</code> 相比 <code>watch()</code> 使我们可以：</p> <ul><li>1️⃣懒执行副作用；</li> <li>2️⃣更加明确是应该由哪个状态触发侦听器重新执行；</li> <li>3️⃣可以访问所侦听状态的旧值和新值。</li></ul> <h5 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h5> <p>侦听一个 <code>getter</code> 函数：</p> <div class="language-TS extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>count<span class="token punctuation">,</span>
  <span class="token punctuation">(</span>count<span class="token punctuation">,</span> prevCount<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>侦听一个 Ref 对象：</p> <div class="language-TS extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">watch</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span>count<span class="token punctuation">,</span> prevCount<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>当侦听多个来源时，回调函数接受两个数组，分别对应来源数组中的新值和旧值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>fooRef<span class="token punctuation">,</span> barRef<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>foo<span class="token punctuation">,</span> bar<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>prevFoo<span class="token punctuation">,</span> prevBar<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当使用 <code>getter</code> 函数作为源时，回调只在此函数的返回值变化时才会触发。</p> <p>如果你想让回调在深层级变更时也能触发，你需要使用 <code>{ deep: true }</code> 强制侦听器进入深层级模式。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 若不开启 deep ，那么这个侦听器永远不会工作，因为 watch() 默认是懒侦听的，即仅在侦听源发生变化时才执行回调函数</span>
    <span class="token comment">// 而且 state 是个常量，不可变，它就不可能触发修改了。</span>
    <span class="token punctuation">{</span> deep<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上一个例子代码等同于下面这个例子，因为当直接侦听一个响应式对象时，<strong>侦听器会自动启用深层模式</strong>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watch</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
    <span class="token comment">/* 深层级变更状态所触发的回调 */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面两个代码都<strong>无法获取到旧值</strong>，因为在深层级模式时，如果回调函数由于深层级的变更而被触发，那么新值和旧值将是同一个对象。</p> <p>若想获取到旧值，我们需要使用 <code>gettet</code> 函数，将指定值返回出去：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>count<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>count<span class="token punctuation">,</span> prevCount<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>watch()</code> 和 <code>watchEffect()</code> 享有相同的刷新时机和调试选项：</p> <div class="language-TS extra-class"><pre class="language-ts"><code><span class="token function">watch</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  flush<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
  <span class="token function">onTrack</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span>
  <span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="参见"><a href="#参见" class="header-anchor">#</a> 参见</h3> <ul><li><a href="https://cn.vuejs.org/api/reactivity-core.html" target="_blank" rel="noopener noreferrer">Vue3-Api-响应式核心<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="响应式工具-api"><a href="#响应式工具-api" class="header-anchor">#</a> 响应式工具 API</h2> <h3 id="isref"><a href="#isref" class="header-anchor">#</a> IsRef</h3> <p>检查某个值是否为 Ref 对象。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">isRef</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>r<span class="token operator">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> r <span class="token keyword">is</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>请注意，返回值是一个<a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates" target="_blank" rel="noopener noreferrer">类型判定<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (type predicate)，这意味着 <code>isRef</code> 可以被用作类型守卫：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> foo<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// foo 的类型被收窄为了 Ref&lt;unknown&gt;</span>
    foo<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="unref"><a href="#unref" class="header-anchor">#</a> UnRef</h3> <p>如果参数是 Ref，则解包内部值返回，否则返回参数本身。</p> <p>这是 <code>val = isRef(val) ? val.value : val</code> 计算的一个语法糖。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">unref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>ref<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">useFoo</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> Ref<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> unwrapped <span class="token operator">=</span> <span class="token function">unref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// unwrapped 现在保证为 number 类型</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="toref"><a href="#toref" class="header-anchor">#</a> ToRef</h3> <p>基于 <code>Reactive</code> 或 普通对象上的属性创建一个对应的 <code>Ref</code> 对象。这样创建的 <code>Ref</code> 与其源属性保持同步：改变源属性的值将更新 <code>Ref</code> 的值，反之亦然。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">toRef</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token punctuation">,</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    object<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    key<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">,</span>
    defaultValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ToRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">ToRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span> <span class="token operator">?</span> <span class="token constant">T</span> <span class="token operator">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p><code>toRef</code> 用来在一个源对象（不论是不是 Reactive）上<strong>单独创建一个属性代理</strong>并返回。</p> <ul><li>源对象上可以没有这个属性，但当修改代理时源对象也会跟着添加或修改这个属性并赋值，反之修改源对象上的指定代理属性值，代理也会跟着修改。</li></ul> <p>第一个参数为需要代理的对象。</p> <p>第二个参数为需要代理的对象上的属性，这个属性在源对象上可以不存在。</p> <p>返回值为这个属性值的 Ref 代理对象的，注意：需要访问 <code>.value</code> 修改。</p> <p><img src="https://sbr-1314368469.cos.ap-guangzhou.myqcloud.com/Images/202301121339115.png" alt="image-20221216110653432"></p></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> barRef <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更改该 ref 会更新源属性</span>
barRef<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token comment">// 更改源属性也会更新该 ref</span>
state<span class="token punctuation">.</span>bar<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>barRef<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>请注意，这不同于：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> fooRef <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面这个 Ref 对象<strong>不会</strong>和 <code>state.foo</code> 保持同步，因为这个 <code>ref()</code> 接收到的是一个纯数值。</p> <p><code>toRef()</code> 这个函数在你想把一个 Prop 的 Ref 传递给一个组合式函数时会很有用：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> toRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将 `props.foo` 转换为 ref，然后传入</span>
<span class="token comment">// 一个组合式函数</span>
<span class="token function">useSomeFeature</span><span class="token punctuation">(</span><span class="token function">toRef</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当 <code>toRef</code> 与组件 props 结合使用时，关于禁止对 props 做出更改的限制依然有效。尝试将新的值传递给 ref 等效于尝试直接更改 props，这是不允许的。</p> <p>所以上面的可以使用 <code>readOnly</code> 创建一个只读代理</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">useSomeFeature</span><span class="token punctuation">(</span><span class="token function">readOnly</span><span class="token punctuation">(</span><span class="token function">toRef</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>在这种场景下，也可以考虑使用带有 <code>get</code> 和 <code>set</code> 的 <a href="https://cn.vuejs.org/api/reactivity-core.html#computed" target="_blank" rel="noopener noreferrer"><code>computed</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 替代。详情请见<a href="https://cn.vuejs.org/guide/components/events.html#usage-with-v-model" target="_blank" rel="noopener noreferrer">在组件上使用 <code>v-model</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 指南。</p> <p>即使源属性当前不存在，<code>toRef()</code> 也会返回一个可用的 ref。这让它在处理可选 props 的时候格外实用，相比之下 <a href="https://cn.vuejs.org/api/reactivity-utilities.html#torefs" target="_blank" rel="noopener noreferrer"><code>toRefs</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就不会为可选 props 创建对应的 refs。</p></blockquote></li></ul> <h3 id="torefs"><a href="#torefs" class="header-anchor">#</a> ToRefs</h3> <p>将一个响应式对象转换为一个普通对象，这个普通对象的每个属性都是指向源对象相应属性的 ref。</p> <p>每个单独的 ref 都是使用 <a href="https://cn.vuejs.org/api/reactivity-utilities.html#toref" target="_blank" rel="noopener noreferrer"><code>toRef()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建的。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">toRefs</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> object<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    object<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> ToRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">ToRef</span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Ref</span> <span class="token operator">?</span> <span class="token constant">T</span> <span class="token operator">:</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p><code>toRefs</code> 可以用来将 Reactive 对象转换为一组 Ref 对象，达到支持结构赋值的同时不丢失响应式的目的。</p> <p>它与 <code>toRef</code> 的区别在于：</p> <ul><li><code>toRef</code> 用于创建对象的单个属性值代理，且源对象上这个属性可以不存在。</li> <li><code>toRef</code> 接收两个参数，<code>toRefs</code> 只接收一个参数。</li></ul></li> <li><p>示例</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    bar<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stateAsRefs <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
stateAsRefs 的类型：{
  foo: Ref&lt;number&gt;,
  bar: Ref&lt;number&gt;
}
*/</span>

<span class="token comment">// 这个 ref 和源属性已经“链接上了”</span>
state<span class="token punctuation">.</span>foo<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stateAsRefs<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

stateAsRefs<span class="token punctuation">.</span>foo<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><p>当组合式函数中返回响应式对象时，<code>toRefs</code> 相当有用。使用它，消费者组件可以解构/展开返回的对象而不会失去响应性：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">useFeatureX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        bar<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...基于状态的操作逻辑</span>

    <span class="token comment">// 在返回时都转为 ref</span>
    <span class="token keyword">return</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 可以解构而不会失去响应性</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useFeatureX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>toRfs</code> 在调用时只会为源对象上可以枚举的属性创建 ref。如果要为可能还不存在的属性创建 ref，请改用 <a href="https://cn.vuejs.org/api/reactivity-utilities.html#toref" target="_blank" rel="noopener noreferrer"><code>toRef</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></li></ul> <h3 id="参见-2"><a href="#参见-2" class="header-anchor">#</a> 参见</h3> <ul><li><a href="https://cn.vuejs.org/api/reactivity-utilities.html" target="_blank" rel="noopener noreferrer">Vue3-Api-响应式工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="依赖注入"><a href="#依赖注入" class="header-anchor">#</a> 依赖注入</h2> <h3 id="provide"><a href="#provide" class="header-anchor">#</a> Provide</h3> <p>提供一个值，可以被后代组件注入使用。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">provide</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>key<span class="token operator">:</span> InjectionKey<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p><code>provide()</code> 接受两个参数：第一个参数是要注入的 key，可以是一个字符串或者一个 symbol，第二个参数是要注入的值。</p> <p>当使用 TypeScript 时，key 可以是一个被类型断言为 <code>InjectionKey</code> 的 symbol。<code>InjectionKey</code> 是一个 Vue 提供的工具类型，继承自 <code>Symbol</code>，可以用来同步 <code>provide()</code> 和 <code>inject()</code> 之间值的类型。</p> <p>与注册生命周期钩子的 API 类似，<code>provide()</code> 必须在组件的 <code>setup()</code> 阶段同步调用。</p> <blockquote><p>详细用法可以查看 <a href="/bigRiceRice.io/dist/2021/12/20/vue3-apis/d:\Desktop\APPFOL~1\工作区\VUE3查~1\Vue3新特性.html">Vue3 新特性</a></p></blockquote></li> <li><p>示例</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> ref<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fooSymbol <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./injectionSymbols&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 提供静态值</span>
<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提供响应式的值</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提供时将 Symbol 作为 key</span>
<span class="token function">provide</span><span class="token punctuation">(</span>fooSymbol<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h3 id="inject"><a href="#inject" class="header-anchor">#</a> Inject</h3> <p>注入一个由祖先组件或整个应用 (通过 <code>app.provide()</code>) 提供的值。</p> <ul><li><p>TS 类型</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 没有默认值</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>key<span class="token operator">:</span> InjectionKey<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

<span class="token comment">// 带有默认值</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>key<span class="token operator">:</span> InjectionKey<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span> defaultValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

<span class="token comment">// 使用工厂函数</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">inject</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    key<span class="token operator">:</span> InjectionKey<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token function-variable function">defaultValue</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    treatDefaultAsFactory<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>详细信息</p> <p>第一个参数是注入的 key。Vue 会遍历父组件链，通过匹配 key 来确定所提供的值。</p> <ul><li>如果父组件链上多个组件对同一个 key 提供了值，那么离得更近的组件将会“覆盖”链上更远的组件所提供的值。</li> <li>如果没有能通过 key 匹配到值，<code>inject()</code> 将返回 <code>undefined</code>，除非提供了一个默认值。</li></ul> <p>第二个参数是可选的，即在没有匹配到 key 时使用的默认值。它也可以是一个工厂函数，用来返回某些创建起来比较复杂的值。</p> <ul><li>如果默认值本身就是一个函数，即工厂函数返回的是一个闭包函数，那么必须将 <code>false</code> 作为第三个参数传入，表明这个函数就是默认值，而不是一个工厂函数。</li></ul> <p>与注册生命周期钩子的 API 类似，<code>inject()</code> 必须在组件的 <code>setup()</code> 阶段同步调用。</p> <p>当使用 TypeScript 时，key 可以是一个类型为 <code>InjectionKey</code> 的 symbol。<code>InjectionKey</code> 是一个 Vue 提供的工具类型，继承自 <code>Symbol</code>，可以用来同步 <code>provide()</code> 和 <code>inject()</code> 之间值的类型。</p></li> <li><p>示例</p> <p>假设有一个父组件已经提供了一些值，如前面 <code>provide()</code> 的例子中所示：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fooSymbol <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./injectionSymbols&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 注入值的默认方式</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注入响应式的值</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 Symbol 类型的 key 注入</span>
<span class="token keyword">const</span> foo2 <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>fooSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注入一个值，若为空则使用提供的默认值</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注入一个值，若为空则使用提供的工厂函数</span>
<span class="token keyword">const</span> baz <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注入时为了表明提供的默认值是个函数，需要传入第三个参数</span>
<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#响应式核心-api" title="响应式核心 API">响应式核心 API</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#ref" title="Ref">Ref</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#computed" title="Computed">Computed</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#reactive" title="Reactive">Reactive</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#readonly" title="Readonly">Readonly</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#watcheffect" title="WatchEffect">WatchEffect</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#watchposteffect" title="WatchPostEffect">WatchPostEffect</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#watchsynceffect" title="WatchSyncEffect">WatchSyncEffect</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#watch" title="Watch">Watch</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#参见" title="参见">参见</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#响应式工具-api" title="响应式工具 API">响应式工具 API</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#isref" title="IsRef">IsRef</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#unref" title="UnRef">UnRef</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#toref" title="ToRef">ToRef</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#torefs" title="ToRefs">ToRefs</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#参见-2" title="参见">参见</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#依赖注入" title="依赖注入">依赖注入</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#provide" title="Provide">Provide</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#inject" title="Inject">Inject</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/bigRiceRice" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>该网站使用 vuepress + @vuepress/theme-blog 搭建 —— by: Big Rice © 2023</li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/bigRiceRice.io/dist/assets/js/app.e40e56d4.js" defer></script><script src="/bigRiceRice.io/dist/assets/js/6.4adeed80.js" defer></script><script src="/bigRiceRice.io/dist/assets/js/3.2a259be5.js" defer></script><script src="/bigRiceRice.io/dist/assets/js/61.10bdb60c.js" defer></script>
  </body>
</html>
